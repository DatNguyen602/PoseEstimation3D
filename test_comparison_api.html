<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Video Comparison</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; padding: 20px; max-width: 1200px; margin: auto; background-color: #f5f5f5; color: #333; }
        h1, h2, h3 { color: #333; }
        #container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        form > div { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="file"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        button {
            display: inline-block;
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        #logs, #result {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        #logs {
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: "SF Mono", "Fira Code", "Fira Mono", "Roboto Mono", monospace;
            font-size: 14px;
            color: #555;
        }
        video { max-width: 100%; border: 1px solid #ccc; border-radius: 5px; margin-top: 10px; background-color: #000; }
        hr { border: none; border-top: 1px solid #eee; margin: 30px 0; }
        #preview-container { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 20px; }
        .video-preview { flex: 1; text-align: center; }
        #progress-container {
            margin: 20px 0;
            padding: 15px;
            background-color: #e8f4fd;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        #progress-bar {
            height: 20px;
            background-color: #007bff;
            border-radius: 10px;
            transition: width 0.3s ease;
            margin-top: 5px;
        }
        .accuracy-high { color: #28a745; font-weight: bold; }
        .accuracy-medium { color: #ffc107; font-weight: bold; }
        .accuracy-low { color: #dc3545; font-weight: bold; }
        .video-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .video-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #fafafa; }
        .video-card h4 { margin-top: 0; color: #495057; }
    </style>
</head>
<body>
    <div id="container">
        <h1>üéØ Test Video Comparison API</h1>
        <p>
            Upload hai video ƒë·ªÉ so s√°nh v√† nh·∫≠n k·∫øt qu·∫£ v·ªõi ƒë·ªô ch√≠nh x√°c v√† video ph√¢n t√≠ch chi ti·∫øt.
        </p>

        <form id="upload-form">
            <div>
                <label for="user_video">üìπ Video c·ªßa b·∫°n:</label>
                <input type="file" id="user_video" name="user_video" accept="video/*" required>
            </div>
            <div>
                <label for="reference_video">üé¨ Video tham chi·∫øu:</label>
                <input type="file" id="reference_video" name="reference_video" accept="video/*" required>
            </div>
            <button type="submit" id="submit-button">üöÄ So s√°nh Videos</button>
        </form>

        <hr>

        <div id="preview-container">
            <div class="video-preview">
                <h3>üìπ Preview Video c·ªßa b·∫°n</h3>
                <video id="user-video-preview" controls muted playsinline width="400"></video>
            </div>
            <div class="video-preview">
                <h3>üé¨ Preview Video tham chi·∫øu</h3>
                <video id="ref-video-preview" controls muted playsinline width="400"></video>
            </div>
        </div>

        <hr>

        <h2>üìä Ti·∫øn ƒë·ªô x·ª≠ l√Ω</h2>
        <div id="progress-container" style="display: none;">
            <div id="progress-text">ƒêang kh·ªüi t·∫°o...</div>
            <div style="width: 100%; background-color: #e0e0e0; border-radius: 10px; height: 20px; overflow: hidden;">
                <div id="progress-bar" style="height: 100%; background-color: #007bff; width: 0%; transition: width 0.3s ease; border-radius: 10px;"></div>
            </div>
        </div>

        <h2>üéØ K·∫øt qu·∫£</h2>
        <div id="result">
            <p>K·∫øt qu·∫£ so s√°nh s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y sau khi x·ª≠ l√Ω ho√†n t·∫•t.</p>
        </div>

        <h2>üìù Logs</h2>
        <pre id="logs">Ch·ªù ƒë·ª£i qu√° tr√¨nh x·ª≠ l√Ω...</pre>
    </div>

    <script>
        const form = document.getElementById('upload-form');
        const logs = document.getElementById('logs');
        const result = document.getElementById('result');
        const submitButton = document.getElementById('submit-button');

        const userVideoInput = document.getElementById('user_video');
        const refVideoInput = document.getElementById('reference_video');
        const userVideoPreview = document.getElementById('user-video-preview');
        const refVideoPreview = document.getElementById('ref-video-preview');

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function createVideoPreview(inputElement, videoElement) {
            inputElement.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const videoURL = URL.createObjectURL(file);
                    videoElement.src = videoURL;
                } else {
                    videoElement.src = '';
                }
            });
        }

        createVideoPreview(userVideoInput, userVideoPreview);
        createVideoPreview(refVideoInput, refVideoPreview);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            logs.textContent = 'üöÄ B·∫Øt ƒë·∫ßu upload v√† so s√°nh...\n';
            result.innerHTML = '<p>‚è≥ ƒêang x·ª≠ l√Ω... Vui l√≤ng ƒë·ª£i.</p>';

            // Show progress bar
            document.getElementById('progress-container').style.display = 'block';
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('progress-text').textContent = 'Kh·ªüi t·∫°o qu√° tr√¨nh...';

            submitButton.disabled = true;
            submitButton.textContent = '‚è≥ ƒêang x·ª≠ l√Ω...';

            const formData = new FormData();
            formData.append('user_video', userVideoInput.files[0]);
            formData.append('reference_video', refVideoInput.files[0]);

            try {
                const response = await fetch('http://127.0.0.1:8000/api/compare_videos/', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`L·ªói server: ${response.status} ${response.statusText}. ${errorText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });

                    let endOfMessage;
                    while ((endOfMessage = buffer.indexOf('\n\n')) !== -1) {
                        const message = buffer.substring(0, endOfMessage);
                        buffer = buffer.substring(endOfMessage + 2);

                        let event = 'message';
                        let data = '';

                        message.split('\n').forEach(line => {
                            if (line.startsWith('event:')) {
                                event = line.replace('event:', '').trim();
                            } else if (line.startsWith('data:')) {
                                data = line.replace('data:', '').trim();
                            }
                        });

                        if (data) {
                            if (event === 'log') {
                                logs.textContent += data + '\n';
                            } else if (event === 'progress') {
                                const progressData = JSON.parse(data);
                                const percentage = progressData.percentage || 0;
                                const message = progressData.message || progressData.step || 'ƒêang x·ª≠ l√Ω...';

                                // Update progress bar
                                document.getElementById('progress-bar').style.width = percentage + '%';
                                document.getElementById('progress-text').textContent = `${percentage}% - ${message}`;

                                logs.textContent += `üìà ${message}\n`;
                            } else if (event === 'result') {
                                const resultData = JSON.parse(data);
                                const videoUrl = resultData.side_by_side_video_url || ('http://127.0.0.1:8000' + resultData.side_by_side_video_path);
                                const annoVideoUrl = resultData.annotated_user_video_url || ('http://127.0.0.1:8000' + resultData.annotated_user_video_path);

                                // Hide progress bar
                                document.getElementById('progress-container').style.display = 'none';

                                // Determine accuracy color class
                                let accuracyClass = 'accuracy-medium';
                                if (resultData.overall_accuracy > 80) accuracyClass = 'accuracy-high';
                                else if (resultData.overall_accuracy < 60) accuracyClass = 'accuracy-low';

                                result.innerHTML = `
                                    <h3>üéâ So s√°nh ho√†n th√†nh!</h3>
                                    <div style="margin-bottom: 20px;">
                                        <h4>üìä ƒê·ªô ch√≠nh x√°c t·ªïng th·ªÉ: <span class="${accuracyClass}">${Math.round(resultData.overall_accuracy)}%</span></h4>
                                        <p><strong>Frames ƒë√£ x·ª≠ l√Ω:</strong> ${resultData.total_frames_processed}</p>
                                    </div>

                                    <div class="video-grid">
                                        <div class="video-card">
                                            <h4>üìπ Video so s√°nh (Side-by-Side)</h4>
                                            <video src="${videoUrl}" controls width="100%"></video>
                                            <p><a href="${videoUrl}" target="_blank">M·ªü trong tab m·ªõi</a></p>
                                        </div>
                                        <div class="video-card">
                                            <h4>üé® Video ph√¢n t√≠ch (Annotated)</h4>
                                            <video src="${annoVideoUrl}" controls width="100%"></video>
                                            <p><a href="${annoVideoUrl}" target="_blank">M·ªü trong tab m·ªõi</a></p>
                                        </div>
                                    </div>

                                    <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-top: 20px;">
                                        <h4>üìã Th√¥ng tin chi ti·∫øt:</h4>
                                        <p><strong>Th·ªùi gian x·ª≠ l√Ω:</strong> ${new Date().toLocaleString()}</p>
                                        <p><strong>Tr·∫°ng th√°i:</strong> ‚úÖ Ho√†n th√†nh</p>
                                    </div>
                                `;
                                logs.textContent += '‚úÖ Nh·∫≠n ƒë∆∞·ª£c k·∫øt qu·∫£! Videos ƒë√£ s·∫µn s√†ng.\n';
                            } else if (event === 'error') {
                                // Hide progress bar on error
                                document.getElementById('progress-container').style.display = 'none';
                                result.innerHTML = `<h3>‚ùå L·ªói</h3><pre>${data}</pre>`;
                                logs.textContent += '‚ùå L·ªñI: ' + data + '\n';
                            } else if (event === 'done') {
                                logs.textContent += 'üèÅ Server ƒë√£ ho√†n th√†nh x·ª≠ l√Ω.\n';
                            }
                        }
                    }
                }
            } catch (error) {
                logs.textContent += 'L·ªói: ' + error.message + '\n';
                result.innerHTML = 'C√≥ l·ªói x·∫£y ra. Ki·ªÉm tra logs v√† ƒë·∫£m b·∫£o server ƒëang ch·∫°y.';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'üöÄ So s√°nh Videos';

                // Hide progress bar if still visible
                document.getElementById('progress-container').style.display = 'none';
            }
        });
    </script>
</body>
</html>
